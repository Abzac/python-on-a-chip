#
# Builds the PyMite VM as an archive
#

# Configure the contents of pmstdlib by editing this list
PMSTDLIB_SOURCES = ../lib/__bi.py \
                   ../lib/sys.py

TARGET ?= DESKTOP
HEAP_SIZE ?= 0x1000
TARGET_MCU ?= atmega103

PMIMGCREATOR := ../tools/pmImgCreator.py
DEFS = -DTARGET_$(TARGET) -DHEAP_SIZE=$(HEAP_SIZE)
CFLAGS = -g -Os -Wall -gstabs -Wstrict-prototypes $(DEFS)
ARFLAGS := rcs
SOURCE_IMG := pmstdlib_img.c
SOURCE_NAT := pmstdlib_nat.c
SOURCES = $(wildcard *.c) $(SOURCE_IMG) $(SOURCE_NAT)
OBJECTS = $(SOURCES:.c=.o)
PRODUCT_VM := libpmvm.a

ifeq ($(TARGET), DESKTOP)
	CFLAGS += -ansi
endif
ifeq ($(TARGET), AVR)
	AR = avr-ar
	CC = avr-gcc
	SIZE = avr-size
	CFLAGS += -mmcu=$(TARGET_MCU) -DTARGET_MCU=$(TARGET_MCU)
endif

.PHONY: all size clean

# Default action is to build the archive from object files
all : $(SOURCE_IMG) $(SOURCE_NAT) $(PRODUCT_VM)

# The archive is generated by placing object files inside it
$(PRODUCT_VM) : $(PRODUCT_VM)($(OBJECTS))

# Build the standard library into an image file and native function file
$(SOURCE_IMG) $(SOURCE_NAT) : $(PMSTDLIB_SOURCES)
	$(PMIMGCREATOR) -c -o $(SOURCE_IMG) --native-file=$(SOURCE_NAT) $(PMSTDLIB_SOURCES)

# Lists the size of the obejcts in the archive
size : $(PRODUCT_VM)
	@$(SIZE) $(PRODUCT_VM)

# Remove files made by default make
clean :
	@$(RM) $(PRODUCT_VM)
	@$(RM) $(SOURCE_IMG) $(SOURCE_NAT)