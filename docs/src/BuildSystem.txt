.. Copyright 2006 Dean Hall
   Permission is granted to copy, distribute and/or modify this document
   under the terms of the GNU Free Documentation License, Version 1.2
   or any later version published by the Free Software Foundation;
   with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
   Texts.  A copy of the license is in the file docs/LICENSE.

=======================
The PyMite Build System
=======================

:Author:    Dean Hall
:Id:        $Id$

Purpose
-------

This document describes the build system for the PyMite project.
In doing so, it serves both as a design document for the PyMite
developer and a user manual for the PyMite user.

Overview
--------

PyMite use a makefile-based build system with an allowance for
using features of `GNU make`_.  The project has a ``Makefile`` in the project
root directory that, when called by typing ``make`` at the command prompt,
compiles for the desktop platform:

    - the PyMite standard library ``src/lib/`` image file,
      ``src/vm/pmstdlib_img.c``, and native code file, ``src/vm/pmstdlib_nat.c``
    - the PyMite VM archive, ``libpmvm.desktop.a``
    - the PyMite executable, ``src/platform/desktop/main.out``

More options for building the project are available by using the available
``make`` targets as explained in the next section.

The PyMite project has a ``src/lib/`` directory that differs in meaning from
most software projects.  Most projects compile source code to create a library
as a product and put that library in a ``lib/`` directory.  PyMite, on the
other hand, converts Python code that is meant to run inside the PyMite VM
to an `image` file, an equivalent to a ``.pyc`` file.  The `image` file is
a C file, ``pmstdlib_img.c``, containing an array of bytes.
The directory ``src/lib/`` is responsible for holding the files of Python
source code which are used to build the standard library.

.. _`GNU make`: http://www.gnu.org/software/make/


Requirements
------------

The PyMite interpreter requires bytecodes created by Python version 2.5 or 2.6.


Available Targets
-----------------

GNU projects have, by convention, a set of typical targets that can be built.
The PyMite build system shall support the following set of targets
by typing ``make`` `<target>` at the command prompt:

``all``:
    Compiles PyMite for the desktop platform.  This is the default target.

``clean``:
    Deletes the files in this and other directories that are created by
    building the program.

``TAGS``:
    Updates a tags index file for this project.
    Also updates cscope databases for the VM and pmstdlib source code.

``html``:
    Generates the documentation files from ``docs/src/`` and
    places the output HTML files in ``docs/html/``.

``dist``:
    Create a distribution tar file for this program.
    *This target should only be used by the PyMite release manager.*

``check``:
    Compiles and executes PyMite self-tests found in ``src/tests/``.


Build Options
-------------

There are a handful of build options that one can provide to ``make`` that
alter PyMite's behavior or set its configuration in some way.  The following
is a list of the build options and their possible values.

``DEBUG``:
    Builds PyMite with extra debugging information and code.
    Possible values: ``true``, ``false``.  The default is ``false``.
    Example: ``make DEBUG=true``

``HEAP_SIZE``:
    Specifies the desired size of the PyMite heap in bytes.
    Possible values can be any positive integer.  To avoid errors, the size
    should be less than the size of physical memory and an integer multiple
    of 4.  The default value is defined in the platform's Makefile.
    Example: ``make HEAP_SIZE=0x1000``

``PLATFORM``:
    Specifies the intended target platform.  Possible values are the names
    of the subdirectories in ``src/platform``: ``at91sam7s-ek``,
    ``avr``, ``mmb103`` and ``desktop``.  The default is ``desktop``.
    Example: ``make PLATFORM=avr``


Self Testing
------------

PyMite has both unit tests and system tests to provide some amount of
code validity.  Running ``make check`` will build the VM if needed and all self
tests and then execute the self tests.  More details on self tests can be found
in Testing_

.. _Testing: Testing.html

Testing the VM is primarily intended for the desktop target because the desktop
offers greater resources (size and execution speed) and can quickly run all
test programs in a batch and report any failures through the command interface.

Running individual test programs on the target device is possible, but one must
either painstakingly step through the program using a debugger or devise a
way to determine the exit code of the VM.  Perhaps running on a device simulator
is a better option.

Distribution
------------

The PyMite release manager should be the only one who uses the
distribution target.  The makefiles shall be configured so that
all the release manager must do is run ``make dist PYMITE_RELEASE=RR``
(where `RR` is the release number, in hexadecimal) to create the
release file, ``pymite-RR.tar.gz``.

The html documentation shall be pre-built and included in the release file.

.. :mode=rest:
